<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kami Flex Tube üé¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f0f0f] text-white font-sans min-h-screen">

  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 bg-[#202020] sticky top-0 z-10">
    <h1 class="text-2xl font-bold text-red-500">Kami Flex Tube</h1>
    <input id="searchInput" type="text" placeholder="Search YouTube videos..."
      class="w-1/2 p-2 rounded-lg bg-[#121212] text-white focus:outline-none">
    <button id="searchBtn"
      class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg ml-2 font-semibold">Search</button>
  </header>

  <!-- Results -->
  <main id="results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 p-4">
    <p class="text-gray-400 text-center col-span-full mt-10">Search something to start üé•</p>
  </main>

  <!-- Player Modal -->
  <div id="playerModal" class="hidden fixed inset-0 bg-black/80 flex justify-center items-center z-50">
    <div class="bg-[#181818] rounded-xl shadow-xl w-[90%] md:w-[60%] p-4 relative">
      <button onclick="closePlayer()" class="absolute top-2 right-3 text-white text-2xl">‚úñ</button>
      <video id="videoPlayer" controls class="w-full rounded-lg"></video>
      <div id="downloadLinks" class="mt-4 space-y-2"></div>
    </div>
  </div>

  <footer class="text-center py-4 text-gray-500 bg-[#202020]">
    ‚ù§Ô∏è Powered by Kami Flex Tube
  </footer>

  <script>
    async function searchVideos() {
      const query = document.getElementById("searchInput").value.trim();
      const results = document.getElementById("results");
      results.innerHTML = `<p class="text-center text-gray-400">üîç Searching...</p>`;

      try {
        const res = await fetch(`/api/tube?action=search&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        const videos = data.result || [];

        if (videos.length === 0) {
          results.innerHTML = `<p class="text-center text-gray-400">‚ö†Ô∏è No videos found.</p>`;
          return;
        }

        results.innerHTML = videos.map(v => `
          <div class="bg-[#181818] p-3 rounded-lg hover:bg-[#202020] transition">
            <img src="${v.thumbnail}" class="rounded-lg w-full mb-2">
            <h3 class="font-bold mb-1 text-white">${v.title}</h3>
            <p class="text-gray-400 text-sm">${v.channel} ‚Ä¢ ${v.duration}</p>
            <button onclick="playVideo('${v.url}')" class="bg-red-600 hover:bg-red-700 mt-2 w-full py-2 rounded-lg font-semibold">‚ñ∂ Play / Download</button>
          </div>
        `).join("");
      } catch (err) {
        results.innerHTML = `<p class="text-center text-gray-400">‚ùå Failed to load videos.</p>`;
      }
    }

    async function playVideo(url) {
      const modal = document.getElementById("playerModal");
      const player = document.getElementById("videoPlayer");
      const downloadLinks = document.getElementById("downloadLinks");

      modal.classList.remove("hidden");
      player.src = "";

      try {
        const res = await fetch(`/api/tube?action=download&url=${encodeURIComponent(url)}`);
        const data = await res.json();

        const vidUrl = data.result?.video?.[0]?.url || "";
        player.src = vidUrl;

        downloadLinks.innerHTML = `
          <h2 class="text-lg font-bold mb-2 text-white">Download Options</h2>
          ${data.result?.video?.map(v => `
            <a href="${v.url}" target="_blank"
               class="block bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg text-center font-semibold">
               üé• ${v.quality} (${v.type})
            </a>
          `).join("") || "No video links found."}

          ${data.result?.audio?.length ? `
          <h2 class="text-lg font-bold mt-4 mb-2 text-white">Audio (MP3)</h2>
          ${data.result.audio.map(a => `
            <a href="${a.url}" target="_blank"
               class="block bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-center font-semibold">
               üéµ ${a.type}
            </a>
          `).join("")}` : ""}
        `;
      } catch (err) {
        downloadLinks.innerHTML = `<p class="text-gray-400">‚ö†Ô∏è Failed to load download links.</p>`;
      }
    }

    function closePlayer() {
      document.getElementById("playerModal").classList.add("hidden");
      document.getElementById("videoPlayer").pause();
    }

    document.getElementById("searchBtn").addEventListener("click", searchVideos);
    document.getElementById("searchInput").addEventListener("keydown", e => {
      if (e.key === "Enter") searchVideos();
    });
  </script>
</body>
</html>
